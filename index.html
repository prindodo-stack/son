<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI코딩 교실 신청 시스템</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Pretendard:wght@400;600;700&display=swap');
        body { font-family: 'Pretendard', sans-serif; background-color: #f8fafc; -webkit-tap-highlight-color: transparent; }
        .step-active { color: #2563eb; border-bottom: 3px solid #2563eb; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; }
        .day-cell { min-height: 80px; transition: all 0.2s; position: relative; border-bottom: 1px solid #f1f5f9; border-right: 1px solid #f1f5f9; }
        .selected-date { background-color: #2563eb !important; color: white !important; }
        .blocked { background-color: #fee2e2; color: #ef4444; cursor: not-allowed; }
        .admin-blocked { background-color: #ef4444 !important; color: white !important; }
        .full { background-color: #f1f5f9; color: #94a3b8; cursor: not-allowed; }
        .loading-overlay { display: none; position: fixed; inset: 0; background: rgba(255,255,255,0.85); z-index: 100; justify-content: center; align-items: center; backdrop-filter: blur(4px); }
    </style>
</head>
<body class="p-4 md:p-8">

    <div id="loading" class="loading-overlay flex flex-col">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
        <p class="mt-4 font-semibold text-blue-600">처리 중...</p>
    </div>

    <div class="max-w-4xl mx-auto bg-white rounded-2xl shadow-2xl overflow-hidden relative">
        <button onclick="toggleAdmin()" class="absolute top-4 right-4 text-gray-300 hover:text-gray-500 text-xs transition z-50">Admin</button>

        <!-- Header -->
        <div class="bg-blue-600 p-8 text-white text-center">
            <h1 id="mainTitle" class="text-2xl md:text-3xl font-bold mb-2">로딩 중...</h1>
            <p id="subTitle" class="opacity-90">-</p>
        </div>

        <!-- User Nav (Steps) -->
        <div id="userNav" class="flex border-b text-center font-semibold text-gray-500">
            <div id="step1Tab" class="flex-1 py-4 step-active">1. 일정 선택</div>
            <div id="step2Tab" class="flex-1 py-4">2. 정보 입력</div>
            <div id="step3Tab" class="flex-1 py-4">3. 신청 완료</div>
        </div>

        <div class="p-6 md:p-10">
            <!-- STEP 1: 일정 선택 (먼저 수행) -->
            <div id="step1" class="space-y-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-bold text-gray-800">교육 희망일 선택</h3>
                    <div class="flex space-x-2">
                        <button onclick="changeMonth(-1)" class="p-2 border rounded hover:bg-gray-100">&lt;</button>
                        <span id="calendarTitle" class="font-bold py-2 min-w-[100px] text-center"></span>
                        <button onclick="changeMonth(1)" class="p-2 border rounded hover:bg-gray-100">&gt;</button>
                    </div>
                </div>
                <div class="calendar-grid text-center font-bold text-xs text-gray-400 mb-1">
                    <div class="text-red-400">일</div><div>월</div><div>화</div><div>수</div><div>목</div><div>금</div><div class="text-blue-400">토</div>
                </div>
                <div id="calendarBody" class="calendar-grid border-t border-l border-gray-100"></div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-6 p-4 bg-blue-50 rounded-xl border border-blue-100">
                    <div>
                        <label class="block text-sm font-bold text-blue-800 mb-1">선택된 날짜</label>
                        <div id="selectedDateText" class="p-3 bg-white border rounded-lg font-bold text-blue-600">- 날짜를 선택하세요 -</div>
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-blue-800 mb-1">시간대 선택</label>
                        <select id="timeSlot" class="w-full p-3 border rounded-lg bg-white outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="오전(4시간)">오전 (4시간: 09:00~13:00)</option>
                            <option value="종일(6시간)">종일 (6시간: 09:00~16:00)</option>
                        </select>
                    </div>
                </div>
                <button onclick="goToStep2()" class="w-full bg-blue-600 text-white font-bold py-4 rounded-xl hover:bg-blue-700 transition shadow-lg">다음 단계로 (정보 입력)</button>
            </div>

            <!-- STEP 2: 정보 입력 (나중에 수행) -->
            <div id="step2" class="hidden space-y-6">
                <div class="bg-gray-50 p-4 rounded-lg mb-6 flex justify-between items-center border">
                    <span class="text-sm font-bold text-gray-600">선택한 일정:</span>
                    <span id="finalDateConfirm" class="text-blue-600 font-bold"></span>
                    <button onclick="goToStep1()" class="text-xs bg-gray-200 px-2 py-1 rounded">날짜변경</button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div><label class="block text-sm font-semibold text-gray-700 mb-1">소속 학교명</label><input type="text" id="schoolName" class="w-full p-3 border rounded-lg outline-none focus:ring-2 focus:ring-blue-500" placeholder="예: 무지개초등학교"></div>
                    <div><label class="block text-sm font-semibold text-gray-700 mb-1">직위</label><input type="text" id="position" class="w-full p-3 border rounded-lg outline-none focus:ring-2 focus:ring-blue-500" placeholder="예: 교사"></div>
                    <div><label class="block text-sm font-semibold text-gray-700 mb-1">신청자 성함</label><input type="text" id="userName" class="w-full p-3 border rounded-lg outline-none focus:ring-2 focus:ring-blue-500" placeholder="실명을 입력하세요"></div>
                    <div><label class="block text-sm font-semibold text-gray-700 mb-1">연락처</label><input type="text" id="phone" oninput="autoHyphen(this)" class="w-full p-3 border rounded-lg outline-none focus:ring-2 focus:ring-blue-500" placeholder="010-0000-0000"></div>
                </div>
                <button onclick="submitApplication()" class="w-full bg-green-600 text-white font-bold py-4 rounded-xl hover:bg-green-700 transition shadow-lg">신청 완료하기</button>
            </div>

            <!-- STEP 3: 신청 완료 -->
            <div id="step3" class="hidden text-center py-16">
                <div class="mb-6 flex justify-center">
                    <div class="bg-green-100 p-4 rounded-full">
                        <svg class="w-12 h-12 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                    </div>
                </div>
                <h2 class="text-3xl font-bold text-gray-800 mb-2">신청이 접수되었습니다!</h2>
                <p class="text-gray-500 mb-8">관리자 승인 후 개별 안내 드립니다.</p>
                <button onclick="location.reload()" class="bg-gray-800 text-white px-8 py-3 rounded-lg hover:bg-black transition">처음으로</button>
            </div>

            <!-- ADMIN PANEL (이전과 동일하게 유지) -->
            <div id="adminPanel" class="hidden space-y-8">
                <div class="flex justify-between items-center border-b pb-4">
                    <h2 class="text-xl font-bold">⚙️ 관리자 시스템 제어</h2>
                    <button onclick="location.reload()" class="text-sm text-blue-600 font-bold underline">사용자 화면으로</button>
                </div>

                <div class="flex space-x-4 border-b">
                    <button onclick="switchAdminTab('status')" id="tabStatus" class="pb-2 border-b-2 border-blue-600 font-bold text-blue-600">신청 현황</button>
                    <button onclick="switchAdminTab('config')" id="tabConfig" class="pb-2 border-b-2 border-transparent text-gray-400 font-bold">시스템 설정/차단일</button>
                </div>

                <!-- Admin Section: Status -->
                <div id="adminStatusSection" class="space-y-4">
                    <div class="flex justify-between items-center">
                        <span class="text-sm font-bold">총 신청: <span id="adminTotalCount">0</span>건</span>
                        <button onclick="exportToExcel()" class="bg-green-600 text-white px-3 py-1 rounded text-sm">엑셀 다운로드</button>
                    </div>
                    <div class="overflow-x-auto border rounded-xl">
                        <table class="w-full text-left text-sm">
                            <thead class="bg-gray-50">
                                <tr><th class="p-3">일시</th><th class="p-3">학교/이름</th><th class="p-3">연락처</th><th class="p-3">희망일</th><th class="p-3">관리</th></tr>
                            </thead>
                            <tbody id="adminDataTable"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Admin Section: Config -->
                <div id="adminConfigSection" class="hidden space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div class="bg-gray-50 p-6 rounded-xl space-y-4 border">
                            <h3 class="font-bold border-b pb-2">기본 설정 변경</h3>
                            <div><label class="text-xs font-bold text-gray-500">메인 타이틀</label><input type="text" id="editTitle" class="w-full p-2 border rounded mt-1 text-sm"></div>
                            <div class="grid grid-cols-2 gap-2">
                                <div><label class="text-xs font-bold text-gray-500">날짜별 제한팀수</label><input type="number" id="editMax" class="w-full p-2 border rounded mt-1 text-sm"></div>
                                <div><label class="text-xs font-bold text-gray-500">강제마감 여부</label>
                                    <select id="editForce" class="w-full p-2 border rounded mt-1 text-sm">
                                        <option value="false">정상 모집</option><option value="true">강제 마감</option>
                                    </select>
                                </div>
                            </div>
                            <div class="grid grid-cols-2 gap-2">
                                <div><label class="text-xs font-bold text-gray-500">신청 시작</label><input type="datetime-local" id="editStart" class="w-full p-2 border rounded mt-1 text-sm"></div>
                                <div><label class="text-xs font-bold text-gray-500">신청 종료</label><input type="datetime-local" id="editEnd" class="w-full p-2 border rounded mt-1 text-sm"></div>
                            </div>
                            <button onclick="saveConfig()" class="w-full bg-blue-600 text-white font-bold py-2 rounded">설정 저장</button>
                        </div>
                        
                        <div class="space-y-4">
                            <h3 class="font-bold border-b pb-2">날짜 차단 설정 (클릭 시 토글)</h3>
                            <div class="bg-white border rounded-xl p-4 shadow-inner">
                                <div id="adminCalendarHeader" class="flex justify-between mb-2 font-bold text-sm"></div>
                                <div class="grid grid-cols-7 gap-1 text-[10px] text-center mb-1 text-gray-400">
                                    <div>일</div><div>월</div><div>화</div><div>수</div><div>목</div><div>금</div><div>토</div>
                                </div>
                                <div id="adminCalendarBody" class="grid grid-cols-7 gap-1"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = "https://zyuybhszykxuafzriksn.supabase.co";
        const SUPABASE_KEY = "sb_publishable_3h3_2LRYgdyeXdoDO6XZMA_4jQrQTtV";
        const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let config = null;
        let blockedDates = [];
        let dailyCountMap = {};
        let currentYear, currentMonth;
        let selectedDate = null;

        window.onload = async () => {
            showLoading(true);
            await loadInitialData();
            const now = new Date();
            currentYear = now.getFullYear();
            currentMonth = now.getMonth();
            renderCalendar();
            checkAppPeriod();
            showLoading(false);
        };

        async function loadInitialData() {
            const [{data: cfg}, {data: blk}, {data: apps}] = await Promise.all([
                _supabase.from('config').select('*').single(),
                _supabase.from('blocked_dates').select('block_date'),
                _supabase.from('applications').select('first_choice')
            ]);
            config = cfg;
            blockedDates = blk.map(b => b.block_date);
            dailyCountMap = {};
            apps.forEach(a => {
                const d = a.first_choice.split(' ')[0];
                dailyCountMap[d] = (dailyCountMap[d] || 0) + 1;
            });

            document.getElementById('mainTitle').innerText = config.main_title;
            document.getElementById('subTitle').innerText = config.sub_title;
        }

        function showLoading(s) { document.getElementById('loading').style.display = s ? 'flex' : 'none'; }

        function renderCalendar() {
            const body = document.getElementById('calendarBody');
            document.getElementById('calendarTitle').innerText = `${currentYear}년 ${currentMonth+1}월`;
            body.innerHTML = '';
            
            const first = new Date(currentYear, currentMonth, 1).getDay();
            const last = new Date(currentYear, currentMonth+1, 0).getDate();

            for(let i=0; i<first; i++) body.appendChild(Object.assign(document.createElement('div'), {className:'day-cell bg-gray-50'}));

            for(let d=1; d<=last; d++) {
                const dateStr = `${currentYear}-${String(currentMonth+1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                const div = document.createElement('div');
                div.className = 'day-cell p-2 text-sm cursor-pointer flex flex-col justify-between';
                div.innerHTML = `<span class="font-bold">${d}</span>`;

                const count = dailyCountMap[dateStr] || 0;
                const isBlocked = blockedDates.includes(dateStr);
                const isWeekend = [0, 6].includes(new Date(dateStr).getDay());
                
                const tag = document.createElement('span');
                tag.className = 'text-[9px] font-bold py-0.5 px-1 rounded text-center';

                if(isBlocked || isWeekend) {
                    div.classList.add('blocked');
                    tag.innerText = "불가";
                } else if(count >= config.max_count) {
                    div.classList.add('full');
                    tag.innerText = "마감";
                    tag.classList.add('bg-gray-200');
                } else {
                    tag.innerText = `가능(${config.max_count-count})`;
                    tag.classList.add('bg-blue-100', 'text-blue-600');
                    div.onclick = () => { selectedDate = dateStr; document.getElementById('selectedDateText').innerText = dateStr; renderCalendar(); };
                }

                if(selectedDate === dateStr) div.classList.add('selected-date');
                div.appendChild(tag);
                body.appendChild(div);
            }
        }

        function changeMonth(v) {
            currentMonth += v;
            if(currentMonth > 11) { currentMonth=0; currentYear++; }
            if(currentMonth < 0) { currentMonth=11; currentYear--; }
            renderCalendar();
            if(!document.getElementById('adminPanel').classList.contains('hidden')) renderAdminCalendar();
        }

        function checkAppPeriod() {
            const now = new Date();
            if(config.is_force_closed) return lock("관리자에 의해 마감되었습니다.");
            if(now < new Date(config.app_start_time)) return lock("신청 기간이 아닙니다.");
            if(now > new Date(config.app_end_time)) return lock("신청이 종료되었습니다.");
        }
        function lock(m) { document.getElementById('step1').innerHTML = `<div class="p-16 text-center text-red-500 font-bold bg-red-50 border rounded-xl">${m}</div>`; }

        // 순서 변경 로직: STEP 1 (날짜 선택) -> STEP 2 (정보 입력)
        function goToStep2() {
            if(!selectedDate) return alert("교육 희망 날짜를 먼저 선택해주세요.");
            document.getElementById('step1').classList.add('hidden');
            document.getElementById('step2').classList.remove('hidden');
            document.getElementById('step1Tab').classList.remove('step-active');
            document.getElementById('step2Tab').classList.add('step-active');
            document.getElementById('finalDateConfirm').innerText = `${selectedDate} (${document.getElementById('timeSlot').value})`;
        }

        function goToStep1() {
            document.getElementById('step2').classList.add('hidden');
            document.getElementById('step1').classList.remove('hidden');
            document.getElementById('step2Tab').classList.remove('step-active');
            document.getElementById('step1Tab').classList.add('step-active');
        }

        async function submitApplication() {
            if(!['schoolName','userName','phone'].every(id => document.getElementById(id).value.trim())) return alert("모든 정보를 입력해주세요.");
            
            showLoading(true);
            const fullDateStr = `${selectedDate} (${document.getElementById('timeSlot').value})`;
            
            // 중복 및 인원 제한 최종 체크
            const {data} = await _supabase.from('applications').select('id').eq('first_choice', fullDateStr);
            if(data && data.length >= config.max_count) {
                showLoading(false);
                alert("선택하신 날짜의 예약이 그새 마감되었습니다. 다른 날짜를 선택해주세요.");
                return goToStep1();
            }

            const {error} = await _supabase.from('applications').insert([{
                school_name: document.getElementById('schoolName').value,
                position: document.getElementById('position').value,
                user_name: document.getElementById('userName').value,
                phone: document.getElementById('phone').value,
                first_choice: fullDateStr
            }]);

            showLoading(false);
            if(error) alert("오류: " + error.message);
            else {
                document.getElementById('step2').classList.add('hidden');
                document.getElementById('step3').classList.remove('hidden');
                document.getElementById('step2Tab').classList.remove('step-active');
                document.getElementById('step3Tab').classList.add('step-active');
            }
        }

        // --- 관리자 전용 로직 ---
        async function toggleAdmin() {
            const p = prompt("Password?");
            if(p === "1416") {
                document.getElementById('userNav').classList.add('hidden');
                document.getElementById('step1').classList.add('hidden');
                document.getElementById('step2').classList.add('hidden');
                document.getElementById('adminPanel').classList.remove('hidden');
                loadAdminData();
                renderAdminCalendar();
                document.getElementById('editTitle').value = config.main_title;
                document.getElementById('editMax').value = config.max_count;
                document.getElementById('editForce').value = String(config.is_force_closed);
                document.getElementById('editStart').value = config.app_start_time.substring(0, 16);
                document.getElementById('editEnd').value = config.app_end_time.substring(0, 16);
            }
        }

        function switchAdminTab(t) {
            document.getElementById('adminStatusSection').style.display = t==='status' ? 'block' : 'none';
            document.getElementById('adminConfigSection').style.display = t==='config' ? 'block' : 'none';
            document.getElementById('tabStatus').className = t==='status' ? 'pb-2 border-b-2 border-blue-600 font-bold text-blue-600' : 'pb-2 border-b-2 border-transparent text-gray-400 font-bold';
            document.getElementById('tabConfig').className = t==='config' ? 'pb-2 border-b-2 border-blue-600 font-bold text-blue-600' : 'pb-2 border-b-2 border-transparent text-gray-400 font-bold';
        }

        async function loadAdminData() {
            const {data} = await _supabase.from('applications').select('*').order('created_at', {ascending:false});
            const tbody = document.getElementById('adminDataTable');
            tbody.innerHTML = '';
            document.getElementById('adminTotalCount').innerText = data ? data.length : 0;
            if(data) {
                data.forEach(app => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td class="p-3 text-[11px]">${app.created_at.substring(5,16).replace('T',' ')}</td>
                        <td class="p-3 font-bold">${app.user_name}<br><span class="text-gray-400 font-normal">${app.school_name}</span></td>
                        <td class="p-3">${app.phone}</td>
                        <td class="p-3 text-blue-600 font-bold text-[11px]">${app.first_choice}</td>
                        <td class="p-3"><button onclick="deleteApp(${app.id})" class="text-red-400 hover:underline">삭제</button></td>
                    `;
                    tbody.appendChild(tr);
                });
            }
        }

        async function deleteApp(id) {
            if(confirm("이 신청 내역을 정말 삭제하시겠습니까?")) {
                await _supabase.from('applications').delete().eq('id', id);
                loadAdminData();
                loadInitialData().then(renderCalendar);
            }
        }

        async function saveConfig() {
            showLoading(true);
            const up = {
                main_title: document.getElementById('editTitle').value,
                max_count: parseInt(document.getElementById('editMax').value),
                is_force_closed: document.getElementById('editForce').value === 'true',
                app_start_time: document.getElementById('editStart').value,
                app_end_time: document.getElementById('editEnd').value
            };
            await _supabase.from('config').update(up).eq('id', 1);
            alert("시스템 설정이 저장되었습니다.");
            location.reload();
        }

        function renderAdminCalendar() {
            const body = document.getElementById('adminCalendarBody');
            document.getElementById('adminCalendarHeader').innerText = `${currentYear}년 ${currentMonth+1}월 차단설정`;
            body.innerHTML = '';
            const first = new Date(currentYear, currentMonth, 1).getDay();
            const last = new Date(currentYear, currentMonth+1, 0).getDate();
            for(let i=0; i<first; i++) body.appendChild(document.createElement('div'));
            for(let d=1; d<=last; d++) {
                const dateStr = `${currentYear}-${String(currentMonth+1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                const div = document.createElement('div');
                div.className = 'p-1 text-[10px] border rounded text-center cursor-pointer hover:bg-gray-100';
                div.innerText = d;
                if(blockedDates.includes(dateStr)) div.classList.add('admin-blocked');
                div.onclick = () => toggleBlock(dateStr);
                body.appendChild(div);
            }
        }

        async function toggleBlock(date) {
            showLoading(true);
            if(blockedDates.includes(date)) await _supabase.from('blocked_dates').delete().eq('block_date', date);
            else await _supabase.from('blocked_dates').insert([{block_date: date}]);
            await loadInitialData();
            renderAdminCalendar();
            renderCalendar();
            showLoading(false);
        }

        function exportToExcel() {
            const table = document.getElementById('adminDataTable').parentElement;
            const ws = XLSX.utils.table_to_sheet(table);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "신청현황");
            XLSX.writeFile(wb, `신청현황_${new Date().toISOString().slice(0,10)}.xlsx`);
        }

        function autoHyphen(t) { 
            t.value = t.value.replace(/[^0-9]/g, '').replace(/^(\d{2,3})(\d{3,4})(\d{4})$/, `$1-$2-$3`); 
        }
    </script>
</body>
</html>
