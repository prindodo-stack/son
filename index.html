<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIì½”ë”© êµì‹¤ ì‹ ì²­ ì‹œìŠ¤í…œ</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Pretendard:wght@400;600;700&display=swap');
        body { font-family: 'Pretendard', sans-serif; background-color: #f8fafc; -webkit-tap-highlight-color: transparent; }
        .step-active { color: #2563eb; border-bottom: 3px solid #2563eb; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; }
        .day-cell { min-height: 80px; transition: all 0.2s; position: relative; border-bottom: 1px solid #f1f5f9; border-right: 1px solid #f1f5f9; }
        
        /* 1ìˆœìœ„ ì„ íƒ ìƒ‰ìƒ */
        .selected-1 { background-color: #2563eb !important; color: white !important; }
        /* 2ìˆœìœ„ ì„ íƒ ìƒ‰ìƒ */
        .selected-2 { background-color: #60a5fa !important; color: white !important; }
        
        .blocked { background-color: #fee2e2; color: #ef4444; cursor: not-allowed; }
        .admin-blocked { background-color: #ef4444 !important; color: white !important; }
        .full { background-color: #f1f5f9; color: #94a3b8; cursor: not-allowed; }
        .loading-overlay { display: none; position: fixed; inset: 0; background: rgba(255,255,255,0.85); z-index: 100; justify-content: center; align-items: center; backdrop-filter: blur(4px); }
        .radio-box:checked + label { border-color: #2563eb; background-color: #eff6ff; color: #1e40af; }
    </style>
</head>
<body class="p-4 md:p-8">

    <div id="loading" class="loading-overlay flex flex-col">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
        <p class="mt-4 font-semibold text-blue-600">ì²˜ë¦¬ ì¤‘...</p>
    </div>

    <div class="max-w-4xl mx-auto bg-white rounded-2xl shadow-2xl overflow-hidden relative">
        <button onclick="toggleAdmin()" class="absolute top-4 right-4 text-gray-300 hover:text-gray-500 text-xs transition z-50">Admin</button>

        <!-- Header -->
        <div class="bg-blue-600 p-8 text-white text-center">
            <h1 id="mainTitle" class="text-2xl md:text-3xl font-bold mb-2">ë¡œë”© ì¤‘...</h1>
            <p id="subTitle" class="opacity-90">-</p>
        </div>

        <!-- User Nav (Steps) -->
        <div id="userNav" class="flex border-b text-center font-semibold text-gray-500">
            <div id="step1Tab" class="flex-1 py-4 step-active">1. ì¼ì • ì„ íƒ</div>
            <div id="step2Tab" class="flex-1 py-4">2. ì •ë³´ ì…ë ¥</div>
            <div id="step3Tab" class="flex-1 py-4">3. ì‹ ì²­ ì™„ë£Œ</div>
        </div>

        <div class="p-6 md:p-10">
            <!-- STEP 1: ì¼ì • ì„ íƒ -->
            <div id="step1" class="space-y-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-bold text-gray-800">êµìœ¡ í¬ë§ì¼ ì„ íƒ <span class="text-sm font-normal text-gray-500 ml-2">(1ìˆœìœ„, 2ìˆœìœ„ë¥¼ ì°¨ë¡€ë¡œ ì„ íƒí•˜ì„¸ìš”)</span></h3>
                    <div class="flex space-x-2">
                        <button onclick="changeMonth(-1)" class="p-2 border rounded hover:bg-gray-100">&lt;</button>
                        <span id="calendarTitle" class="font-bold py-2 min-w-[100px] text-center"></span>
                        <button onclick="changeMonth(1)" class="p-2 border rounded hover:bg-gray-100">&gt;</button>
                    </div>
                </div>
                <div class="calendar-grid text-center font-bold text-xs text-gray-400 mb-1">
                    <div class="text-red-400">ì¼</div><div>ì›”</div><div>í™”</div><div>ìˆ˜</div><div>ëª©</div><div>ê¸ˆ</div><div class="text-blue-400">í† </div>
                </div>
                <div id="calendarBody" class="calendar-grid border-t border-l border-gray-100"></div>
                
                <div class="grid grid-cols-2 gap-4 mt-6">
                    <div class="p-4 bg-blue-50 rounded-xl border border-blue-100 text-center">
                        <label class="block text-xs font-bold text-blue-800 mb-1">1ìˆœìœ„ í¬ë§ì¼</label>
                        <div id="firstChoiceText" class="p-2 bg-white border rounded-lg font-bold text-blue-600 text-sm">- ì„ íƒ -</div>
                    </div>
                    <div class="p-4 bg-blue-50 rounded-xl border border-blue-100 text-center">
                        <label class="block text-xs font-bold text-blue-400 mb-1">2ìˆœìœ„ í¬ë§ì¼</label>
                        <div id="secondChoiceText" class="p-2 bg-white border rounded-lg font-bold text-blue-400 text-sm">- ì„ íƒ -</div>
                    </div>
                </div>
                <button onclick="goToStep2()" class="w-full bg-blue-600 text-white font-bold py-4 rounded-xl hover:bg-blue-700 transition shadow-lg">ë‹¤ìŒ ë‹¨ê³„ë¡œ (ì •ë³´ ì…ë ¥)</button>
            </div>

            <!-- STEP 2: ì •ë³´ ì…ë ¥ -->
            <div id="step2" class="hidden space-y-6">
                <div class="bg-gray-50 p-4 rounded-lg mb-6 border">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-sm font-bold text-gray-600">ì„ íƒí•œ ì¼ì •</span>
                        <button onclick="goToStep1()" class="text-xs bg-gray-200 px-2 py-1 rounded">ë‚ ì§œë³€ê²½</button>
                    </div>
                    <div class="flex gap-4">
                        <div class="flex-1 text-center bg-white p-2 border rounded">
                            <p class="text-[10px] text-gray-400">1ìˆœìœ„</p>
                            <p id="confirmDate1" class="text-blue-600 font-bold"></p>
                        </div>
                        <div class="flex-1 text-center bg-white p-2 border rounded">
                            <p class="text-[10px] text-gray-400">2ìˆœìœ„</p>
                            <p id="confirmDate2" class="text-blue-400 font-bold"></p>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-1">ì†Œì† ì§€ì—­</label>
                        <select id="region" class="w-full p-3 border rounded-lg outline-none focus:ring-2 focus:ring-blue-500 bg-white">
                            <option value="">ì§€ì—­ ì„ íƒ</option>
                            <option value="ëª©í¬">ëª©í¬</option><option value="ì—¬ìˆ˜">ì—¬ìˆ˜</option><option value="ìˆœì²œ">ìˆœì²œ</option>
                            <option value="ë‚˜ì£¼">ë‚˜ì£¼</option><option value="ê´‘ì–‘">ê´‘ì–‘</option><option value="ë‹´ì–‘">ë‹´ì–‘</option>
                            <option value="ê³¡ì„±">ê³¡ì„±</option><option value="êµ¬ë¡€">êµ¬ë¡€</option><option value="ê³ í¥">ê³ í¥</option>
                            <option value="ë³´ì„±">ë³´ì„±</option><option value="í™”ìˆœ">í™”ìˆœ</option><option value="ì¥í¥">ì¥í¥</option>
                            <option value="ê°•ì§„">ê°•ì§„</option><option value="í•´ë‚¨">í•´ë‚¨</option><option value="ì˜ì•”">ì˜ì•”</option>
                            <option value="ë¬´ì•ˆ">ë¬´ì•ˆ</option><option value="í•¨í‰">í•¨í‰</option><option value="ì˜ê´‘">ì˜ê´‘</option>
                            <option value="ì¥ì„±">ì¥ì„±</option><option value="ì™„ë„">ì™„ë„</option><option value="ì§„ë„">ì§„ë„</option>
                            <option value="ì‹ ì•ˆ">ì‹ ì•ˆ</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-1">í•™êµê¸‰</label>
                        <div class="flex gap-4">
                            <div class="flex-1">
                                <input type="radio" name="schoolLevel" id="levelEle" value="ì´ˆ" class="hidden radio-box" checked>
                                <label for="levelEle" class="block w-full text-center p-3 border rounded-lg cursor-pointer font-semibold bg-white">ì´ˆ</label>
                            </div>
                            <div class="flex-1">
                                <input type="radio" name="schoolLevel" id="levelMid" value="ì¤‘" class="hidden radio-box">
                                <label for="levelMid" class="block w-full text-center p-3 border rounded-lg cursor-pointer font-semibold bg-white">ì¤‘</label>
                            </div>
                        </div>
                    </div>
                    <div><label class="block text-sm font-semibold text-gray-700 mb-1">ì†Œì† í•™êµëª…</label><input type="text" id="schoolName" class="w-full p-3 border rounded-lg outline-none focus:ring-2 focus:ring-blue-500" placeholder="ì˜ˆ: ë¬´ì§€ê°œì´ˆë“±í•™êµ"></div>
                    <div><label class="block text-sm font-semibold text-gray-700 mb-1">ì§ìœ„</label><input type="text" id="position" class="w-full p-3 border rounded-lg outline-none focus:ring-2 focus:ring-blue-500" placeholder="ì˜ˆ: êµì‚¬"></div>
                    <div><label class="block text-sm font-semibold text-gray-700 mb-1">ì‹ ì²­ì ì„±í•¨</label><input type="text" id="userName" class="w-full p-3 border rounded-lg outline-none focus:ring-2 focus:ring-blue-500" placeholder="ì‹¤ëª…ì„ ì…ë ¥í•˜ì„¸ìš”"></div>
                    <div><label class="block text-sm font-semibold text-gray-700 mb-1">ì—°ë½ì²˜</label><input type="text" id="phone" oninput="autoHyphen(this)" class="w-full p-3 border rounded-lg outline-none focus:ring-2 focus:ring-blue-500" placeholder="010-0000-0000"></div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-1">í•™ìƒìˆ˜(ëª…)</label>
                        <input type="number" id="studentCount" class="w-full p-3 border rounded-lg outline-none focus:ring-2 focus:ring-blue-500" placeholder="ìˆ«ìë§Œ ì…ë ¥">
                    </div>
                </div>

                <!-- í†µí•™ì°¨ëŸ‰ ì„ íƒ -->
                <div class="p-5 border rounded-xl bg-gray-50 space-y-4">
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-3">í†µí•™ì°¨ëŸ‰ ìš´ì˜ ì—¬ë¶€</label>
                        <div class="flex gap-4">
                            <div class="flex-1">
                                <input type="radio" name="busNeeded" id="busYes" value="ìœ " class="hidden radio-box" onchange="toggleBusType(true)">
                                <label for="busYes" class="block w-full text-center p-3 border rounded-lg cursor-pointer font-semibold bg-white">ìœ </label>
                            </div>
                            <div class="flex-1">
                                <input type="radio" name="busNeeded" id="busNo" value="ë¬´" class="hidden radio-box" onchange="toggleBusType(false)" checked>
                                <label for="busNo" class="block w-full text-center p-3 border rounded-lg cursor-pointer font-semibold bg-white">ë¬´</label>
                            </div>
                        </div>
                    </div>

                    <div id="busTypeSection" class="hidden animate-fade-in border-t pt-4">
                        <label class="block text-sm font-bold text-gray-700 mb-3">ì°¨ëŸ‰ êµ¬ë¶„</label>
                        <div class="flex gap-4">
                            <div class="flex-1">
                                <input type="radio" name="busType" id="busTypeDirect" value="ì§ì˜" class="hidden radio-box">
                                <label for="busTypeDirect" class="block w-full text-center p-3 border rounded-lg cursor-pointer font-semibold bg-white">ì§ì˜</label>
                            </div>
                            <div class="flex-1">
                                <input type="radio" name="busType" id="busTypeRent" value="ì„ì°¨" class="hidden radio-box">
                                <label for="busTypeRent" class="block w-full text-center p-3 border rounded-lg cursor-pointer font-semibold bg-white">ì„ì°¨</label>
                            </div>
                        </div>
                    </div>
                </div>

                <button onclick="submitApplication()" class="w-full bg-green-600 text-white font-bold py-4 rounded-xl hover:bg-green-700 transition shadow-lg">ì‹ ì²­ ì™„ë£Œí•˜ê¸°</button>
            </div>

            <!-- STEP 3: ì‹ ì²­ ì™„ë£Œ -->
            <div id="step3" class="hidden text-center py-16">
                <div class="mb-6 flex justify-center">
                    <div class="bg-green-100 p-4 rounded-full">
                        <svg class="w-12 h-12 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                    </div>
                </div>
                <h2 class="text-3xl font-bold text-gray-800 mb-2">ì‹ ì²­ì´ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤!</h2>
                <p class="text-gray-500 mb-8">ê´€ë¦¬ì ìŠ¹ì¸ í›„ ê°œë³„ ì•ˆë‚´ ë“œë¦½ë‹ˆë‹¤.</p>
                <button onclick="location.reload()" class="bg-gray-800 text-white px-8 py-3 rounded-lg hover:bg-black transition">ì²˜ìŒìœ¼ë¡œ</button>
            </div>

            <!-- ADMIN PANEL -->
            <div id="adminPanel" class="hidden space-y-8">
                <div class="flex justify-between items-center border-b pb-4">
                    <h2 class="text-xl font-bold">âš™ï¸ ê´€ë¦¬ì ì‹œìŠ¤í…œ ì œì–´</h2>
                    <button onclick="location.reload()" class="text-sm text-blue-600 font-bold underline">ì‚¬ìš©ì í™”ë©´ìœ¼ë¡œ</button>
                </div>

                <div class="flex space-x-4 border-b">
                    <button onclick="switchAdminTab('status')" id="tabStatus" class="pb-2 border-b-2 border-blue-600 font-bold text-blue-600">ì‹ ì²­ í˜„í™©</button>
                    <button onclick="switchAdminTab('config')" id="tabConfig" class="pb-2 border-b-2 border-transparent text-gray-400 font-bold">ì‹œìŠ¤í…œ ì„¤ì •/ì°¨ë‹¨ì¼</button>
                </div>

                <!-- Admin Section: Status -->
                <div id="adminStatusSection" class="space-y-4">
                    <div class="flex justify-between items-center">
                        <span class="text-sm font-bold">ì´ ì‹ ì²­: <span id="adminTotalCount">0</span>ê±´</span>
                        <button onclick="exportToExcel()" class="bg-green-600 text-white px-3 py-1 rounded text-sm">ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</button>
                    </div>
                    <div class="overflow-x-auto border rounded-xl">
                        <table class="w-full text-left text-sm whitespace-nowrap">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="p-3">ì¼ì‹œ</th>
                                    <th class="p-3">í•™êµê¸‰/ì§€ì—­</th>
                                    <th class="p-3">í•™êµ/ì´ë¦„</th>
                                    <th class="p-3">ì—°ë½ì²˜</th>
                                    <th class="p-3">í¬ë§ì¼(1ìˆœìœ„)</th>
                                    <th class="p-3">í¬ë§ì¼(2ìˆœìœ„)</th>
                                    <th class="p-3">í•™ìƒìˆ˜</th>
                                    <th class="p-3">ì°¨ëŸ‰ì •ë³´</th>
                                    <th class="p-3">ê´€ë¦¬</th>
                                </tr>
                            </thead>
                            <tbody id="adminDataTable"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Admin Section: Config -->
                <div id="adminConfigSection" class="hidden space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div class="bg-gray-50 p-6 rounded-xl space-y-4 border">
                            <h3 class="font-bold border-b pb-2">ì‹œìŠ¤í…œ ì„¤ì • ë³€ê²½</h3>
                            <div><label class="text-xs font-bold text-gray-500">ë©”ì¸ íƒ€ì´í‹€</label><input type="text" id="editTitle" class="w-full p-2 border rounded mt-1 text-sm"></div>
                            
                            <div class="grid grid-cols-2 gap-2 p-3 bg-blue-50 rounded-lg border border-blue-100">
                                <div class="col-span-2 text-xs font-bold text-blue-700 mb-1">ğŸ“… êµìœ¡ ìš´ì˜ ê¸°ê°„ (ë‹¬ë ¥ í™œì„±í™” ë²”ìœ„)</div>
                                <div><label class="text-[10px] text-gray-500">ì‹œì‘ì¼</label><input type="date" id="editEduStart" class="w-full p-2 border rounded mt-1 text-sm"></div>
                                <div><label class="text-[10px] text-gray-500">ì¢…ë£Œì¼</label><input type="date" id="editEduEnd" class="w-full p-2 border rounded mt-1 text-sm"></div>
                            </div>

                            <div class="grid grid-cols-2 gap-2">
                                <div><label class="text-xs font-bold text-gray-500">ë‚ ì§œë³„ ì œí•œíŒ€ìˆ˜</label><input type="number" id="editMax" class="w-full p-2 border rounded mt-1 text-sm"></div>
                                <div><label class="text-xs font-bold text-gray-500">ê°•ì œë§ˆê° ì—¬ë¶€</label>
                                    <select id="editForce" class="w-full p-2 border rounded mt-1 text-sm">
                                        <option value="false">ì •ìƒ ëª¨ì§‘</option><option value="true">ê°•ì œ ë§ˆê°</option>
                                    </select>
                                </div>
                            </div>
                            <div class="grid grid-cols-2 gap-2">
                                <div><label class="text-xs font-bold text-gray-500">ì‹ ì²­ ì‹œì‘(ì‹œê°„)</label><input type="datetime-local" id="editStart" class="w-full p-2 border rounded mt-1 text-sm"></div>
                                <div><label class="text-xs font-bold text-gray-500">ì‹ ì²­ ì¢…ë£Œ(ì‹œê°„)</label><input type="datetime-local" id="editEnd" class="w-full p-2 border rounded mt-1 text-sm"></div>
                            </div>
                            <button onclick="saveConfig()" class="w-full bg-blue-600 text-white font-bold py-2 rounded">ì„¤ì • ì €ì¥</button>
                        </div>
                        
                        <div class="space-y-4">
                            <div class="flex justify-between items-center border-b pb-2">
                                <h3 class="font-bold">ë‚ ì§œ ì°¨ë‹¨ ì„¤ì •</h3>
                                <div class="flex space-x-1">
                                    <button onclick="changeMonth(-1)" class="px-2 py-1 border rounded text-xs hover:bg-gray-100">&lt;</button>
                                    <button onclick="changeMonth(1)" class="px-2 py-1 border rounded text-xs hover:bg-gray-100">&gt;</button>
                                </div>
                            </div>
                            <div class="bg-white border rounded-xl p-4 shadow-inner">
                                <div id="adminCalendarHeader" class="text-center mb-2 font-bold text-sm"></div>
                                <div class="grid grid-cols-7 gap-1 text-[10px] text-center mb-1 text-gray-400">
                                    <div>ì¼</div><div>ì›”</div><div>í™”</div><div>ìˆ˜</div><div>ëª©</div><div>ê¸ˆ</div><div>í† </div>
                                </div>
                                <div id="adminCalendarBody" class="grid grid-cols-7 gap-1"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = "https://zyuybhszykxuafzriksn.supabase.co";
        const SUPABASE_KEY = "sb_publishable_3h3_2LRYgdyeXdoDO6XZMA_4jQrQTtV";
        const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let config = null;
        let blockedDates = [];
        let dailyCountMap = {};
        let currentYear, currentMonth;
        
        // í¬ë§ ë‚ ì§œ ë³€ìˆ˜ (1ìˆœìœ„, 2ìˆœìœ„)
        let firstChoice = null;
        let secondChoice = null;

        window.onload = async () => {
            showLoading(true);
            const now = new Date();
            currentYear = now.getFullYear();
            currentMonth = now.getMonth();
            await loadInitialData();
            renderCalendar();
            checkAppPeriod();
            showLoading(false);
        };

        async function loadInitialData() {
            try {
                const [cfgRes, blkRes, appsRes] = await Promise.all([
                    _supabase.from('config').select('*').single(),
                    _supabase.from('blocked_dates').select('block_date'),
                    _supabase.from('applications').select('first_choice')
                ]);

                config = cfgRes.data || { main_title: 'AIì½”ë”© êµì‹¤ ì‹ ì²­ ì‹œìŠ¤í…œ', max_count: 1, is_force_closed: false };
                blockedDates = blkRes.data ? blkRes.data.map(b => b.block_date) : [];
                
                dailyCountMap = {};
                if(appsRes.data) {
                    appsRes.data.forEach(a => {
                        if(a.first_choice) {
                            const d = a.first_choice.split(' ')[0];
                            dailyCountMap[d] = (dailyCountMap[d] || 0) + 1;
                        }
                    });
                }

                document.getElementById('mainTitle').innerText = config.main_title || 'AIì½”ë”© êµì‹¤ ì‹ ì²­ ì‹œìŠ¤í…œ';
                document.getElementById('subTitle').innerText = config.sub_title || '-';
            } catch (e) {
                console.error("ì´ˆê¸° ë°ì´í„° ë¡œë“œ ì¤‘ ì˜¤ë¥˜:", e);
            }
        }

        function showLoading(s) { document.getElementById('loading').style.display = s ? 'flex' : 'none'; }

        function toggleBusType(show) {
            const section = document.getElementById('busTypeSection');
            if (show) section.classList.remove('hidden');
            else section.classList.add('hidden');
        }

        // ë‚ ì§œ ì„ íƒ ë¡œì§
        function handleDateClick(dateStr) {
            // ì´ë¯¸ 1ìˆœìœ„ë¡œ ì„ íƒëœ ë‚ ì§œë¼ë©´ í•´ì œ
            if (firstChoice === dateStr) {
                firstChoice = secondChoice; // 2ìˆœìœ„ê°€ ìˆì—ˆë‹¤ë©´ 1ìˆœìœ„ë¡œ ìŠ¹ê²©
                secondChoice = null;
            } 
            // ì´ë¯¸ 2ìˆœìœ„ë¡œ ì„ íƒëœ ë‚ ì§œë¼ë©´ í•´ì œ
            else if (secondChoice === dateStr) {
                secondChoice = null;
            }
            // ì•„ë¬´ê²ƒë„ ì•„ë‹ˆë©´ ìƒˆë¡œ ì§€ì •
            else {
                if (!firstChoice) {
                    firstChoice = dateStr;
                } else if (!secondChoice) {
                    secondChoice = dateStr;
                } else {
                    // ë‘˜ ë‹¤ ì°¼ì„ ë•Œ í´ë¦­í•˜ë©´ 2ìˆœìœ„ë¥¼ êµì²´
                    secondChoice = dateStr;
                }
            }
            
            updateChoiceDisplay();
            renderCalendar();
        }

        function updateChoiceDisplay() {
            document.getElementById('firstChoiceText').innerText = firstChoice || '- ì„ íƒ -';
            document.getElementById('secondChoiceText').innerText = secondChoice || '- ì„ íƒ -';
        }

        function renderCalendar() {
            const body = document.getElementById('calendarBody');
            document.getElementById('calendarTitle').innerText = `${currentYear}ë…„ ${currentMonth+1}ì›”`;
            body.innerHTML = '';
            
            const first = new Date(currentYear, currentMonth, 1).getDay();
            const last = new Date(currentYear, currentMonth+1, 0).getDate();

            const opStart = (config && config.edu_op_start) ? new Date(config.edu_op_start) : null;
            const opEnd = (config && config.edu_op_end) ? new Date(config.edu_op_end) : null;

            for(let i=0; i<first; i++) body.appendChild(Object.assign(document.createElement('div'), {className:'day-cell bg-gray-50'}));

            for(let d=1; d<=last; d++) {
                const dateStr = `${currentYear}-${String(currentMonth+1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                const div = document.createElement('div');
                div.className = 'day-cell p-2 text-sm flex flex-col justify-between';
                
                // ìˆœìœ„ í‘œì‹œìš© ìˆ«ì ì¶”ê°€
                let badge = "";
                if (firstChoice === dateStr) badge = "<span class='absolute top-1 right-1 bg-white text-blue-600 text-[10px] px-1 rounded-full border border-blue-600 font-bold'>1ìˆœìœ„</span>";
                if (secondChoice === dateStr) badge = "<span class='absolute top-1 right-1 bg-white text-blue-400 text-[10px] px-1 rounded-full border border-blue-400 font-bold'>2ìˆœìœ„</span>";
                
                div.innerHTML = `<span class="font-bold">${d}</span>${badge}`;

                const thisDate = new Date(dateStr);
                const count = dailyCountMap[dateStr] || 0;
                const isBlocked = blockedDates.includes(dateStr);
                const isWeekend = [0, 6].includes(thisDate.getDay());
                
                let isOutRange = false;
                if(opStart && thisDate < opStart) isOutRange = true;
                if(opEnd && thisDate > opEnd) isOutRange = true;

                const tag = document.createElement('span');
                tag.className = 'text-[9px] font-bold py-0.5 px-1 rounded text-center';

                if(isOutRange) {
                    div.classList.add('bg-gray-100', 'text-gray-300', 'cursor-not-allowed');
                    tag.innerText = "ë¹„ìš´ì˜";
                } else if(isBlocked || isWeekend) {
                    div.classList.add('blocked');
                    tag.innerText = "ë¶ˆê°€";
                } else if(config && count >= config.max_count) {
                    div.classList.add('full');
                    tag.innerText = "ë§ˆê°";
                    tag.classList.add('bg-gray-200');
                } else {
                    div.classList.add('cursor-pointer');
                    tag.innerText = config ? `ê°€ëŠ¥(${config.max_count-count})` : 'ê°€ëŠ¥';
                    tag.classList.add('bg-blue-100', 'text-blue-600');
                    div.onclick = () => handleDateClick(dateStr);
                }

                if(firstChoice === dateStr) div.classList.add('selected-1');
                else if(secondChoice === dateStr) div.classList.add('selected-2');

                div.appendChild(tag);
                body.appendChild(div);
            }
        }

        function changeMonth(v) {
            currentMonth += v;
            if(currentMonth > 11) { currentMonth=0; currentYear++; }
            if(currentMonth < 0) { currentMonth=11; currentYear--; }
            renderCalendar();
            if(!document.getElementById('adminPanel').classList.contains('hidden')) renderAdminCalendar();
        }

        function checkAppPeriod() {
            if(!config) return;
            const now = new Date();
            if(config.is_force_closed) return lock("ê´€ë¦¬ìì— ì˜í•´ ë§ˆê°ë˜ì—ˆìŠµë‹ˆë‹¤.");
            if(config.app_start_time && now < new Date(config.app_start_time)) return lock("ì‹ ì²­ ê¸°ê°„ì´ ì•„ë‹™ë‹ˆë‹¤.");
            if(config.app_end_time && now > new Date(config.app_end_time)) return lock("ì‹ ì²­ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
        }
        function lock(m) { document.getElementById('step1').innerHTML = `<div class="p-16 text-center text-red-500 font-bold bg-red-50 border rounded-xl">${m}</div>`; }

        function goToStep2() {
            if(!firstChoice) return alert("ìµœì†Œ 1ìˆœìœ„ í¬ë§ ë‚ ì§œëŠ” ì„ íƒí•´ì•¼ í•©ë‹ˆë‹¤.");
            document.getElementById('step1').classList.add('hidden');
            document.getElementById('step2').classList.remove('hidden');
            document.getElementById('step1Tab').classList.remove('step-active');
            document.getElementById('step2Tab').classList.add('step-active');
            
            document.getElementById('confirmDate1').innerText = firstChoice;
            document.getElementById('confirmDate2').innerText = secondChoice || 'ë¯¸ì„ íƒ';
        }

        function goToStep1() {
            document.getElementById('step2').classList.add('hidden');
            document.getElementById('step1').classList.remove('hidden');
            document.getElementById('step2Tab').classList.remove('step-active');
            document.getElementById('step1Tab').classList.add('step-active');
        }

        async function submitApplication() {
            const fields = ['region', 'schoolName','userName','phone','studentCount'];
            if(!fields.every(id => document.getElementById(id).value.trim())) return alert("ëª¨ë“  í•„ìˆ˜ ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            
            const schoolLevel = document.querySelector('input[name="schoolLevel"]:checked').value;
            const busNeeded = document.querySelector('input[name="busNeeded"]:checked').value;
            let busType = "í•´ë‹¹ì—†ìŒ";
            if(busNeeded === "ìœ ") {
                const selectedType = document.querySelector('input[name="busType"]:checked');
                if(!selectedType) return alert("í†µí•™ì°¨ëŸ‰ ìš´ì˜ 'ìœ ' ì„ íƒ ì‹œ, ì°¨ëŸ‰ êµ¬ë¶„ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
                busType = selectedType.value;
            }

            showLoading(true);
            
            // 1ìˆœìœ„ ë§ˆê° ì—¬ë¶€ ìµœì¢… ì²´í¬
            const {data} = await _supabase.from('applications').select('id').eq('first_choice', firstChoice);
            if(config && data && data.length >= config.max_count) {
                showLoading(false);
                alert("ì„ íƒí•˜ì‹  1ìˆœìœ„ ë‚ ì§œì˜ ì˜ˆì•½ì´ ê·¸ìƒˆ ë§ˆê°ë˜ì—ˆìŠµë‹ˆë‹¤. ì¼ì •ì„ ë‹¤ì‹œ ì¡°ì •í•´ì£¼ì„¸ìš”.");
                return goToStep1();
            }

            const {error} = await _supabase.from('applications').insert([{
                region: document.getElementById('region').value,
                school_level: schoolLevel,
                school_name: document.getElementById('schoolName').value,
                position: document.getElementById('position').value,
                user_name: document.getElementById('userName').value,
                phone: document.getElementById('phone').value,
                first_choice: firstChoice,
                second_choice: secondChoice, // 2ìˆœìœ„ ë°ì´í„° í¬í•¨
                student_count: parseInt(document.getElementById('studentCount').value),
                bus_needed: busNeeded,
                bus_type: busType
            }]);

            showLoading(false);
            if(error) alert("ì˜¤ë¥˜: " + error.message);
            else {
                document.getElementById('step2').classList.add('hidden');
                document.getElementById('step3').classList.remove('hidden');
                document.getElementById('step2Tab').classList.remove('step-active');
                document.getElementById('step3Tab').classList.add('step-active');
            }
        }

        async function toggleAdmin() {
            const p = prompt("Password?");
            if(p === "1416") {
                try {
                    document.getElementById('userNav').classList.add('hidden');
                    document.getElementById('step1').classList.add('hidden');
                    document.getElementById('step2').classList.add('hidden');
                    document.getElementById('adminPanel').classList.remove('hidden');
                    await loadAdminData();
                    renderAdminCalendar();
                    if(config) {
                        document.getElementById('editTitle').value = config.main_title || '';
                        document.getElementById('editMax').value = config.max_count || 1;
                        document.getElementById('editForce').value = String(config.is_force_closed || false);
                        const formatTime = (t) => (t && t.length >= 16) ? t.substring(0, 16).replace(' ', 'T') : '';
                        document.getElementById('editStart').value = formatTime(config.app_start_time);
                        document.getElementById('editEnd').value = formatTime(config.app_end_time);
                        document.getElementById('editEduStart').value = config.edu_op_start || '';
                        document.getElementById('editEduEnd').value = config.edu_op_end || '';
                    }
                } catch (e) {
                    alert("ê´€ë¦¬ì í˜ì´ì§€ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                }
            } else if (p !== null) alert("ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.");
        }

        function switchAdminTab(t) {
            document.getElementById('adminStatusSection').style.display = t==='status' ? 'block' : 'none';
            document.getElementById('adminConfigSection').style.display = t==='config' ? 'block' : 'none';
            document.getElementById('tabStatus').className = t==='status' ? 'pb-2 border-b-2 border-blue-600 font-bold text-blue-600' : 'pb-2 border-b-2 border-transparent text-gray-400 font-bold';
            document.getElementById('tabConfig').className = t==='config' ? 'pb-2 border-b-2 border-blue-600 font-bold text-blue-600' : 'pb-2 border-b-2 border-transparent text-gray-400 font-bold';
        }

        async function loadAdminData() {
            const {data} = await _supabase.from('applications').select('*').order('created_at', {ascending:false});
            const tbody = document.getElementById('adminDataTable');
            tbody.innerHTML = '';
            document.getElementById('adminTotalCount').innerText = data ? data.length : 0;
            if(data) {
                data.forEach(app => {
                    const tr = document.createElement('tr');
                    const createdAtStr = app.created_at ? app.created_at.substring(5,16).replace('T',' ') : '-';
                    tr.innerHTML = `
                        <td class="p-3 text-[11px]">${createdAtStr}</td>
                        <td class="p-3"><span class="bg-gray-100 px-1 rounded font-bold">${app.school_level || '-'}</span> ${app.region || '-'}</td>
                        <td class="p-3 font-bold">${app.user_name || 'ì´ë¦„ì—†ìŒ'}<br><span class="text-gray-400 font-normal text-[11px]">${app.school_name || '-'}</span></td>
                        <td class="p-3">${app.phone || '-'}</td>
                        <td class="p-3 text-blue-600 font-bold text-[11px]">${app.first_choice}</td>
                        <td class="p-3 text-blue-400 font-bold text-[11px]">${app.second_choice || '-'}</td>
                        <td class="p-3 text-center">${app.student_count || '0'}ëª…</td>
                        <td class="p-3 text-[11px]">${app.bus_needed === 'ìœ ' ? `<span class='text-blue-500 font-bold'>ìš´ì˜(${app.bus_type})</span>` : 'ë¯¸ìš´ì˜'}</td>
                        <td class="p-3"><button onclick="deleteApp(${app.id})" class="text-red-400 hover:underline">ì‚­ì œ</button></td>
                    `;
                    tbody.appendChild(tr);
                });
            }
        }

        async function deleteApp(id) {
            if(confirm("ì´ ì‹ ì²­ ë‚´ì—­ì„ ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                await _supabase.from('applications').delete().eq('id', id);
                await loadAdminData();
                await loadInitialData();
                renderCalendar();
            }
        }

        async function saveConfig() {
            showLoading(true);
            const up = {
                id: 1,
                main_title: document.getElementById('editTitle').value,
                max_count: parseInt(document.getElementById('editMax').value) || 1,
                is_force_closed: document.getElementById('editForce').value === 'true',
                app_start_time: document.getElementById('editStart').value,
                app_end_time: document.getElementById('editEnd').value,
                edu_op_start: document.getElementById('editEduStart').value,
                edu_op_end: document.getElementById('editEduEnd').value
            };
            const { error } = await _supabase.from('config').upsert(up);
            showLoading(false);
            if(error) alert("ì €ì¥ ì‹¤íŒ¨: " + error.message);
            else { alert("ì‹œìŠ¤í…œ ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤."); location.reload(); }
        }

        function renderAdminCalendar() {
            const body = document.getElementById('adminCalendarBody');
            document.getElementById('adminCalendarHeader').innerText = `${currentYear}ë…„ ${currentMonth+1}ì›”`;
            body.innerHTML = '';
            const first = new Date(currentYear, currentMonth, 1).getDay();
            const last = new Date(currentYear, currentMonth+1, 0).getDate();
            for(let i=0; i<first; i++) body.appendChild(document.createElement('div'));
            for(let d=1; d<=last; d++) {
                const dateStr = `${currentYear}-${String(currentMonth+1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                const div = document.createElement('div');
                div.className = 'p-1 text-[10px] border rounded text-center cursor-pointer hover:bg-gray-100';
                div.innerText = d;
                if(blockedDates.includes(dateStr)) div.classList.add('admin-blocked');
                div.onclick = () => toggleBlock(dateStr);
                body.appendChild(div);
            }
        }

        async function toggleBlock(date) {
            showLoading(true);
            if(blockedDates.includes(date)) await _supabase.from('blocked_dates').delete().eq('block_date', date);
            else await _supabase.from('blocked_dates').insert([{block_date: date}]);
            await loadInitialData();
            renderAdminCalendar();
            renderCalendar();
            showLoading(false);
        }

        function exportToExcel() {
            const table = document.getElementById('adminDataTable').parentElement;
            const ws = XLSX.utils.table_to_sheet(table);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "ì‹ ì²­í˜„í™©");
            XLSX.writeFile(wb, `ì‹ ì²­í˜„í™©_${new Date().toISOString().slice(0,10)}.xlsx`);
        }

        function autoHyphen(t) { 
            t.value = t.value.replace(/[^0-9]/g, '').replace(/^(\d{2,3})(\d{3,4})(\d{4})$/, `$1-$2-$3`); 
        }
    </script>
</body>
</html>
